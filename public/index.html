<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TfL Status Board</title>

  <style>
    :root {
      --row-font: 30px;
      --row-padding: 18px;
    }

    body {
      margin: 0;
      background: black;
      color: white;
      font-family: "Johnston100", "JohnstonITC", Arial, sans-serif;
      overflow: hidden;
    }

    .container {
      display: grid;
      gap: 24px;
      padding: 30px;
      box-sizing: border-box;
    }

    @media (orientation: portrait) {
      .container { grid-template-columns: 1fr; }
    }

    @media (orientation: landscape) {
      .container { grid-template-columns: 1fr 1fr; }
    }

    .table { width: 100%; }

    .row {
      display: grid;
      grid-template-columns: 1.2fr 0.8fr;
      padding: var(--row-padding) 24px;
      font-size: var(--row-font);
      align-items: center;
      box-sizing: border-box;
    }

    .line {
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      padding-right: 12px;
    }

    .status {
      text-align: right;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
  </style>
</head>

<body>
  <div id="container" class="container"></div>

  <script>
    // ---------- scaling ----------
    function clamp(v, min, max) {
      return Math.max(min, Math.min(v, max));
    }

    function applyAutoScale() {
      var scale = (window.innerHeight || 1080) / 1080;
      var root = document.documentElement;
      root.style.setProperty("--row-font", String(clamp(30 * scale, 18, 52)) + "px");
      root.style.setProperty("--row-padding", String(clamp(18 * scale, 10, 30)) + "px");
    }

    if (window.addEventListener) {
      window.addEventListener("resize", applyAutoScale);
    }
    applyAutoScale();

    // ---------- colours ----------
    var lineColours = {
      "Bakerloo": "#B36305",
      "Central": "#E32017",
      "Circle": "#FFD300",
      "District": "#00782A",
      "Hammersmith & City": "#F3A9BB",
      "Jubilee": "#A0A5A9",
      "Metropolitan": "#9B0056",
      "Northern": "#000000",
      "Piccadilly": "#003688",
      "Victoria": "#0098D4",
      "Waterloo & City": "#76D0BD",
      "Elizabeth line": "#6950A1",
      "London Overground": "#EE7C0E",
      "Weaver line": "#00B2A9",
      "Mildmay line": "#0076A8",
      "Windrush line": "#E24E42",
      "Suffragette line": "#5A2D81",
      "Lioness line": "#F4A300",
      "Liberty line": "#6E6E6E"
    };

    // ---------- state ----------
    var overgroundLines = [];
    var overgroundIndex = 0;

    function isLandscape() {
      try {
        return window.matchMedia && window.matchMedia("(orientation: landscape)").matches;
      } catch (e) {
        return (window.innerWidth || 1920) > (window.innerHeight || 1080);
      }
    }

    function safeGetStatus(lineObj) {
      // avoids optional chaining
      if (!lineObj) return "Unknown";
      if (!lineObj.lineStatuses) return "Unknown";
      if (!lineObj.lineStatuses[0]) return "Unknown";
      return lineObj.lineStatuses[0].statusSeverityDescription || "Unknown";
    }

    function clearContainer() {
      var container = document.getElementById("container");
      while (container.firstChild) container.removeChild(container.firstChild);
    }

    function createRow(id, name, status, bg) {
      var row = document.createElement("div");
      row.className = "row";
      if (id) row.id = id;
      row.style.background = bg || "#333";

      var left = document.createElement("div");
      left.className = "line";
      left.appendChild(document.createTextNode(name));

      var right = document.createElement("div");
      right.className = "status";
      right.appendChild(document.createTextNode(status));

      row.appendChild(left);
      row.appendChild(right);
      return row;
    }

    function render(rows) {
      clearContainer();
      var container = document.getElementById("container");

      var cols = isLandscape() ? 2 : 1;
      var tables = [];
      var i;

      for (i = 0; i < cols; i++) tables.push([]);

      for (i = 0; i < rows.length; i++) {
        tables[i % cols].push(rows[i]);
      }

      for (i = 0; i < tables.length; i++) {
        var table = document.createElement("div");
        table.className = "table";

        var j;
        for (j = 0; j < tables[i].length; j++) {
          table.appendChild(tables[i][j]);
        }
        container.appendChild(table);
      }
    }

    function updateOvergroundRow() {
      if (!overgroundLines || overgroundLines.length === 0) return;

      var line = overgroundLines[overgroundIndex];
      var row = document.getElementById("overground-row");
      if (!row) return;

      var bg = lineColours[line.name] || lineColours["London Overground"] || "#333";
      var displayName = (line.name || "Overground").replace(" line", "");
      var status = safeGetStatus(line);

      row.style.background = bg;

      // update left/right cells safely
      var left = row.getElementsByClassName("line")[0];
      var right = row.getElementsByClassName("status")[0];
      if (left) left.textContent = displayName;
      if (right) right.textContent = status;

      overgroundIndex = (overgroundIndex + 1) % overgroundLines.length;
    }

    function sortByName(a, b) {
      var an = (a && a.name) ? a.name : "";
      var bn = (b && b.name) ? b.name : "";
      return an.localeCompare ? an.localeCompare(bn) : (an > bn ? 1 : (an < bn ? -1 : 0));
    }

    function httpGetJson(url, onOk, onErr) {
      // Use fetch if available, otherwise XHR
      if (window.fetch) {
        fetch(url, { cache: "no-store" })
          .then(function (res) { return res.json(); })
          .then(function (json) { onOk(json); })
          .catch(function () { onErr(); });
        return;
      }

      var xhr = new XMLHttpRequest();
      xhr.open("GET", url, true);
      xhr.onreadystatechange = function () {
        if (xhr.readyState === 4) {
          if (xhr.status >= 200 && xhr.status < 300) {
            try {
              onOk(JSON.parse(xhr.responseText));
            } catch (e) {
              onErr();
            }
          } else {
            onErr();
          }
        }
      };
      xhr.send();
    }

    function loadStatus() {
      httpGetJson("/api/rail-status",
        function (lines) {
          // split services
          var tube = [];
          var elizabeth = null;
          overgroundLines = [];

          var i;
          for (i = 0; i < lines.length; i++) {
            var l = lines[i];
            if (!l) continue;
            if (l.modeName === "tube") tube.push(l);
            else if (l.modeName === "elizabeth-line") elizabeth = l;
            else if (l.modeName === "overground") overgroundLines.push(l);
          }

          tube.sort(sortByName);
          overgroundLines.sort(sortByName);

          var rows = [];
          for (i = 0; i < tube.length; i++) {
            var t = tube[i];
            rows.push(createRow(
              null,
              t.name,
              safeGetStatus(t),
              lineColours[t.name] || "#333"
            ));
          }

          if (elizabeth) {
            rows.push(createRow(
              null,
              "Elizabeth line",
              safeGetStatus(elizabeth),
              lineColours["Elizabeth line"] || "#333"
            ));
          }

          if (overgroundLines.length) {
            // placeholder row; will rotate names/status
            rows.push(createRow(
              "overground-row",
              "Overground",
              "Loadingâ€¦",
              lineColours["London Overground"] || "#333"
            ));
            overgroundIndex = 0;
          }

          render(rows);
          updateOvergroundRow();
        },
        function () {
          // fail safe
          var rows = [createRow(null, "TfL Status", "Data unavailable", "#333")];
          render(rows);
        }
      );
    }

    // rotate + refresh
    setInterval(updateOvergroundRow, 3000);
    setInterval(loadStatus, 60000);

    loadStatus();
  </script>
</body>
</html>
